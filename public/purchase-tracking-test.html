<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Tracking Test Page</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }

        h2 {
            color: #555;
            margin-top: 30px;
        }

        .test-section {
            background: #f9f9f9;
            padding: 20px;
            margin: 15px 0;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #45a049;
        }

        button.secondary {
            background: #2196F3;
        }

        button.secondary:hover {
            background: #0b7dda;
        }

        .info {
            background: #e3f2fd;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            border-left: 4px solid #2196F3;
        }

        .success {
            background: #e8f5e9;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }

        .warning {
            background: #fff3e0;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            border-left: 4px solid #ff9800;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
        }

        .console-output {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .console-output .error {
            color: #ef5350;
        }

        .console-output .success {
            color: #66bb6a;
        }

        .console-output .info {
            color: #42a5f5;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üõí Purchase Tracking Test Page</h1>

        <div class="info">
            <strong>‚ÑπÔ∏è Test Environment</strong>
            <p>This page simulates a purchase confirmation page to test the KaliFinder purchase tracking service.</p>
            <p><strong>Current URL:</strong> <code id="current-url"></code></p>
        </div>

        <h2>1Ô∏è‚É£ Simulate Thank-You Page URL</h2>
        <div class="test-section">
            <p>Change the URL to simulate navigating to a thank-you/order confirmation page:</p>
            <button onclick="simulateShopifyThankYou()">Shopify Thank You Page</button>
            <button onclick="simulateWooCommerceThankYou()">WooCommerce Order Received</button>
            <button onclick="simulateGenericThankYou()">Generic Thank You Page</button>
            <button class="secondary" onclick="resetURL()">Reset URL</button>
        </div>

        <h2>2Ô∏è‚É£ Dispatch Platform Events</h2>
        <div class="test-section">
            <p>Manually dispatch platform-specific purchase events:</p>
            <button onclick="dispatchShopifyEvent()">Shopify Checkout Completed</button>
            <button onclick="dispatchWooCommerceEvent()">WooCommerce Order Received</button>
            <button onclick="dispatchGenericEvent()">Generic Purchase Event</button>
        </div>

        <h2>3Ô∏è‚É£ Setup Test Cart Data</h2>
        <div class="test-section">
            <p>Populate localStorage with cart data for tracking:</p>
            <button onclick="setupCartData()">Setup Cart Data</button>
            <button class="secondary" onclick="clearCartData()">Clear Cart Data</button>
            <button class="secondary" onclick="viewCartData()">View Cart Data</button>
        </div>

        <h2>4Ô∏è‚É£ Simulate Order Confirmation Page</h2>
        <div class="test-section">
            <p>Add order confirmation elements to the page:</p>
            <button onclick="addOrderElements()">Add Order Elements</button>
            <button class="secondary" onclick="removeOrderElements()">Remove Order Elements</button>
        </div>

        <div id="order-elements-container"></div>

        <h2>üìä Console Output</h2>
        <div class="console-output" id="console-output">
            Console logs will appear here...
        </div>

        <h2>üìù Instructions</h2>
        <div class="warning">
            <strong>‚ö†Ô∏è Prerequisites:</strong>
            <ol>
                <li>Ensure the KaliFinder Search UI widget is loaded on this page</li>
                <li>Open browser DevTools Console (F12) for detailed logs</li>
                <li>Enable debug mode: <code>localStorage.setItem('debug', 'kalifind:*')</code></li>
            </ol>
        </div>

        <div class="success">
            <strong>‚úÖ Testing Steps:</strong>
            <ol>
                <li><strong>Setup cart data</strong> - Click "Setup Cart Data" to create test cart tracking data</li>
                <li><strong>Add order elements</strong> - Click "Add Order Elements" to create order number/total on
                    page</li>
                <li><strong>Simulate URL change</strong> - Click one of the URL simulation buttons</li>
                <li><strong>Check console</strong> - Look for "Purchase detected" and "Purchase tracked successfully"
                    messages</li>
                <li><strong>Verify backend</strong> - Check that the <code>purchase_completed</code> event was sent to
                    API</li>
            </ol>
        </div>

        <h2>üß™ Alternative Test Methods</h2>
        <div class="test-section">
            <p><strong>Method 1: Direct Event Dispatch (Recommended)</strong></p>
            <pre>window.dispatchEvent(new CustomEvent('kalifind:purchase_completed', {
  detail: {
    orderId: 'TEST_' + Date.now(),
    revenue: 99.99,
    productIds: ['prod_1', 'prod_2'],
    currency: 'USD'
  }
}));</pre>

            <p><strong>Method 2: URL Navigation (May require refresh)</strong></p>
            <pre>window.history.pushState({}, '', '/checkout/thank-you?order_id=12345');</pre>

            <p><strong>Method 3: Full Page Reload</strong></p>
            <pre>window.location.href = '/checkout/thank-you?order_id=12345';</pre>
        </div>
    </div>

    <script>
        // Console output interceptor
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addToConsoleOutput(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${timestamp}] ${message}`;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function (...args) {
            originalLog.apply(console, args);
            addToConsoleOutput(args.join(' '), 'info');
        };

        console.error = function (...args) {
            originalError.apply(console, args);
            addToConsoleOutput(args.join(' '), 'error');
        };

        console.warn = function (...args) {
            originalWarn.apply(console, args);
            addToConsoleOutput(args.join(' '), 'warning');
        };

        // Update current URL display
        function updateCurrentURL() {
            document.getElementById('current-url').textContent = window.location.href;
        }
        updateCurrentURL();

        // URL Simulation Functions
        function simulateShopifyThankYou() {
            const orderId = Math.floor(Math.random() * 100000);
            window.history.pushState({}, '', `/checkouts/thank_you?order_id=${orderId}`);
            updateCurrentURL();
            console.log(`Simulated Shopify thank you page with order ID: ${orderId}`);
        }

        function simulateWooCommerceThankYou() {
            const orderId = Math.floor(Math.random() * 100000);
            window.history.pushState({}, '', `/checkout/order-received/${orderId}/?key=wc_order_${orderId}`);
            updateCurrentURL();
            console.log(`Simulated WooCommerce order received page with order ID: ${orderId}`);
        }

        function simulateGenericThankYou() {
            const orderId = Math.floor(Math.random() * 100000);
            window.history.pushState({}, '', `/thank-you?order_id=${orderId}`);
            updateCurrentURL();
            console.log(`Simulated generic thank you page with order ID: ${orderId}`);
        }

        function resetURL() {
            window.history.pushState({}, '', window.location.pathname);
            updateCurrentURL();
            console.log('URL reset to original');
        }

        // Event Dispatch Functions
        function dispatchShopifyEvent() {
            const orderId = 'SHOP_' + Date.now();
            window.dispatchEvent(new CustomEvent('shopify:checkout:completed', {
                detail: {
                    orderId: orderId,
                    total: 149.99,
                    items: [
                        { id: 'prod_123' },
                        { id: 'prod_456' }
                    ],
                    currency: 'USD'
                }
            }));
            console.log(`Dispatched Shopify checkout completed event with order ID: ${orderId}`);
        }

        function dispatchWooCommerceEvent() {
            const orderId = 'WOO_' + Date.now();
            window.dispatchEvent(new CustomEvent('woocommerce:order_received', {
                detail: {
                    orderId: orderId,
                    total: 199.99,
                    items: [
                        { id: 'prod_789' }
                    ],
                    currency: 'USD'
                }
            }));
            console.log(`Dispatched WooCommerce order received event with order ID: ${orderId}`);
        }

        function dispatchGenericEvent() {
            const orderId = 'GEN_' + Date.now();
            window.dispatchEvent(new CustomEvent('kalifind:purchase_completed', {
                detail: {
                    orderId: orderId,
                    revenue: 99.99,
                    productIds: ['prod_111', 'prod_222', 'prod_333'],
                    currency: 'USD'
                }
            }));
            console.log(`Dispatched generic purchase completed event with order ID: ${orderId}`);
        }

        // Cart Data Functions
        function setupCartData() {
            const cartData = {
                totalValue: 299.97,
                itemCount: 3,
                productIds: ['prod_test_1', 'prod_test_2', 'prod_test_3']
            };
            localStorage.setItem('kalifind_cart_data', JSON.stringify(cartData));
            console.log('Cart data setup:', cartData);
        }

        function clearCartData() {
            localStorage.removeItem('kalifind_cart_data');
            console.log('Cart data cleared');
        }

        function viewCartData() {
            const cartData = localStorage.getItem('kalifind_cart_data');
            if (cartData) {
                console.log('Current cart data:', JSON.parse(cartData));
            } else {
                console.log('No cart data found');
            }
        }

        // Order Elements Functions
        function addOrderElements() {
            const container = document.getElementById('order-elements-container');
            const orderId = Math.floor(Math.random() * 100000);

            container.innerHTML = `
        <div class="success" style="margin-top: 20px;">
          <h3>‚úÖ Order Confirmation</h3>
          <p><strong>Order Number:</strong> <span class="order-number" data-order-id="${orderId}">#${orderId}</span></p>
          <p><strong>Order Total:</strong> <span class="order-total">$299.97</span></p>
          <p>Thank you for your purchase!</p>
        </div>
      `;

            console.log(`Added order confirmation elements with order ID: ${orderId}`);
        }

        function removeOrderElements() {
            document.getElementById('order-elements-container').innerHTML = '';
            console.log('Removed order confirmation elements');
        }

        // Initial setup message
        console.log('Purchase Tracking Test Page loaded');
        console.log('Use the buttons above to test different purchase tracking scenarios');

        // Check if widget is loaded
        setTimeout(() => {
            if (window.KALIFIND_STORE_ID) {
                console.log('‚úÖ KaliFinder widget detected');
                console.log('Store ID:', window.KALIFIND_STORE_ID);
                console.log('Vendor ID:', window.KALIFIND_VENDOR_ID);
            } else {
                console.warn('‚ö†Ô∏è KaliFinder widget not detected - some features may not work');
            }
        }, 1000);
    </script>
</body>

</html>