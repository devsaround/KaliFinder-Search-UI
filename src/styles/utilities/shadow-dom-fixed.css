/**
 * Shadow DOM Fixed Positioning Utilities
 * 
 * Critical CSS overrides to ensure position:fixed works correctly inside Shadow DOM.
 * Addresses transform containment issues and viewport-relative positioning.
 * 
 * References:
 * - https://stackoverflow.com/questions/30271404/how-should-position-fixed-work-in-a-shadow-dom-root
 * - https://github.com/floating-ui/floating-ui/issues/1488
 * - https://bugs.webkit.org/show_bug.cgi?id=216240
 * - https://developer.mozilla.org/en-US/docs/Web/CSS/Guides/CSSOM_view/Viewport_concepts
 */

/* ========================================
   SHADOW HOST REQUIREMENTS
   ======================================== */

/**
 * Critical: Shadow host and all ancestors MUST NOT have these properties:
 * - transform (creates containing block)
 * - filter (creates containing block)
 * - perspective (creates containing block)
 * - will-change: transform (creates containing block)
 * - contain: layout/paint/strict (may affect fixed positioning)
 * 
 * NOTE: Base widget/modal transform resets are in layout/widget-container.css
 * This file only handles floating container-specific fixes to avoid duplication.
 * 
 * ⚠️  DEFENSIVE STYLING: These rules protect against future refactors that might
 * accidentally add transforms/filters to parent elements, silently breaking
 * position:fixed on mobile (especially iOS).
 */

/* Enforce no-transform policy on widget root and critical ancestors */
.kalifinder-widget-root,
.kalifinder-widget-root [data-kalifinder-no-transform] {
  transform: none !important;
  perspective: none !important;
  filter: none !important;
  will-change: auto !important;
  contain: none !important;
}

/* ========================================
   FLOATING CONTAINERS
   ======================================== */ /**
 * Two-layer approach for Shadow DOM fixed positioning:
 * 1. Host container (static, no transforms)
 * 2. Fixed child (true viewport-fixed with safe-area-insets)
 */

/* Host containers - prevent containment issues */
[data-floating-host] {
  position: static !important;
  contain: none !important;
  transform: none !important;
  filter: none !important;
  perspective: none !important;
  will-change: auto !important;
}

/* Fixed children - true viewport-fixed */
[data-floating-container] {
  position: fixed !important;
  z-index: 99999 !important;

  /* Ensure proper stacking context */
  isolation: isolate;

  /* Prevent transform on self (affects nested fixed elements) */
  transform: none !important;

  /* Optimize rendering */
  will-change: bottom;
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
}

/* Mobile container - spans full width with padding */
[data-floating-container='mobile'] {
  left: 0 !important;
  right: 0 !important;
  bottom: calc(env(safe-area-inset-bottom, 0px) + 1.5rem) !important;

  /* Responsive offset for small screens */
  @media (max-width: 480px) {
    bottom: calc(env(safe-area-inset-bottom, 0px) + 1rem) !important;
  }
}

/* Desktop container - positioned to right side */
[data-floating-container='desktop'] {
  right: 1.5rem !important;
  bottom: calc(env(safe-area-inset-bottom, 0px) + 1.5rem) !important;

  /* Responsive offset for medium screens */
  @media (max-width: 1280px) {
    right: 1rem !important;
  }
}

/* ========================================
   SAFE AREA INSETS
   ======================================== */

/**
 * Floating container positioning approach - DO NOT CONFUSE with mobile-cross-browser.css
 * 
 * This file: Uses calc() BOTTOM offset for viewport-fixed positioning
 * mobile-cross-browser.css: Adds PADDING to modal content
 * 
 * Both are needed and serve different purposes - not redundant!
 * 
 * iOS Safe Area support for devices with home indicators
 * Ensures floating buttons remain visible above notches and home indicators
 */

@supports (padding: env(safe-area-inset-bottom)) {
  /* Dynamic safe area adjustment is handled via inline styles */
  /* Fallback padding is already applied via calc() in inline styles */
}

/* ========================================
   VIEWPORT UNITS FALLBACK
   ======================================== */

/**
 * Fallback for browsers that don't support dvh (dynamic viewport height)
 * Primarily affects older mobile browsers
 * Handled via JavaScript visual viewport API for dynamic adjustments
 */

/* ========================================
   ACCESSIBILITY
   ======================================== */

/**
 * Ensure floating containers don't interfere with screen readers
 * and maintain proper focus management
 * Individual buttons within containers should have proper aria-labels
 */

/* Focus styles for keyboard navigation */
[data-floating-container] button:focus-visible,
[data-floating-container] a:focus-visible {
  outline: 2px solid #7c3aed;
  outline-offset: 2px;
  border-radius: 9999px;
}

/* ========================================
   TOUCH TARGET SIZES
   ======================================== */

/**
 * Ensure minimum 44x44px touch targets per WCAG AA
 * Critical for mobile usability
 */

[data-floating-container] button,
[data-floating-container] a {
  min-height: 44px;
  min-width: 44px;

  /* Increase for better mobile UX */
  @media (max-width: 480px) {
    min-height: 48px;
    min-width: 48px;
  }
}

/* ========================================
   PERFORMANCE OPTIMIZATIONS
   ======================================== */

/**
 * Optimize rendering and prevent layout thrashing
 * Especially important for mobile devices
 */

[data-floating-container] {
  /* GPU acceleration for smooth animations */
  -webkit-transform: translateZ(0);
  transform: translateZ(0);

  /* Optimize compositing */
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;

  /* Prevent subpixel rendering issues */
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Prevent pointer-events on transparent areas */
[data-floating-container] {
  pointer-events: none;
}

[data-floating-container] > * {
  pointer-events: auto;
}

/* ========================================
   KEYBOARD VISIBLE STATE
   ======================================== */

/**
 * Dynamic adjustments when mobile keyboard is open
 * Handled via JavaScript visual viewport API
 * These classes are toggled programmatically
 */

[data-floating-container][data-keyboard-visible='true'] {
  /* Extra offset is applied via inline styles */
  /* to keep button visible above keyboard */
  transition: bottom 0.3s ease-out;
}

[data-floating-container][data-keyboard-visible='false'] {
  /* Restore default offset when keyboard closes */
  transition: bottom 0.2s ease-in;
}

/* ========================================
   CROSS-BROWSER COMPATIBILITY
   ======================================== */

/**
 * Vendor-specific fixes for known issues
 */

/* Safari/WebKit: Force GPU acceleration */
@supports (-webkit-appearance: none) {
  [data-floating-container] {
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
  }
}

/* Firefox: Prevent subpixel rendering issues */
@-moz-document url-prefix() {
  [data-floating-container] {
    transform: translateZ(0);
  }
}

/* Chrome/Edge: Optimize compositing */
@supports (not (-moz-appearance: none)) {
  [data-floating-container] {
    will-change: bottom;
  }
}

/* ========================================
   DEBUG MODE
   ======================================== */

/**
 * Visual debugging for containment issues
 * Add data-debug="true" to floating containers
 */

[data-floating-container][data-debug='true'] {
  outline: 2px solid red !important;
  outline-offset: 2px;
}

[data-floating-host][data-debug='true'] {
  outline: 2px solid blue !important;
  outline-offset: 2px;
}

/* Show containment warnings in console */
[data-floating-container][data-debug='true']::before {
  content: 'Fixed Container';
  position: absolute;
  top: -20px;
  left: 0;
  background: red;
  color: white;
  padding: 2px 6px;
  font-size: 10px;
  border-radius: 2px;
  z-index: 100000;
}

[data-floating-host][data-debug='true']::before {
  content: 'Host Container (should have no transforms)';
  position: absolute;
  top: -20px;
  left: 0;
  background: blue;
  color: white;
  padding: 2px 6px;
  font-size: 10px;
  border-radius: 2px;
  z-index: 100000;
}
